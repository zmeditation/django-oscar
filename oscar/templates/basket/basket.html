{% extends "checkout/layout.html" %}
{% load currency_filters %}
{% load product_tags %}

{% block title %}
Basket | {{ block.super }}
{% endblock %}

{% block checkout-nav %}
<nav class="checkoutNav">
	<ul class="nav row-fluid">
		<li class="active span3">
			<h3>1. Basket</h3>
		</li>
		<li class="disabled span3">
			<h3>2. Shipping Address</h3>
		</li>
		<li class="disabled span3">
			<h3>3. Shipping Options</h3>
		</li>
		<!-- <li class="disabled span3">
			<h3>4. Payment</h3>
		</li> -->
		<li class="disabled span3">
			<h3>4. Place Order</h3>
		</li>
	</ul>
</nav>
{% endblock %}

{% block header %}
<div class="page-header">
    <h1>Basket</h1>
</div>
{% endblock header %}

{% block content %}

{% if request.basket.lines.count %}

<form action="." method="post" class="basket_summary" id="basket_formset">
    {% csrf_token %}
    {{ formset.management_form }}
    <table class="table table-striped table-bordered">
        <tbody>
        {% for form in formset %}
        <tr>
			<td>
				{{ form.id }}
				{% product_image form.instance.product as product_image %}
				<div style="width:100px">
					<a href="{{ product.get_absolute_url }}"><img class="thumbnail" src="{{ product_image.thumbnail_url }}" alt="{{ product.get_title }}"></a>
				</div>
				<a href="{{ form.instance.product.get_absolute_url }}">{{ form.instance.description }}</a><br/>
				{{ form.instance.product.stockrecord.availability }}
			</td>
			<td>
				{{ form.quantity }} <button class="btn btn-small">Update</button><br/>
				<a href="#" data-id="{{ forloop.counter0 }}" class="remove">Remove</a>
				{% if request.user.is_authenticated %}
					| <a href="#" data-id="{{ forloop.counter0 }}" class="save">Save for later</a>
				{% endif %}
				<div style="display:none">
					{{ form.save_for_later }}
					{{ form.DELETE }}
				</div>
			</td>
            <td>{{ form.instance.unit_price_incl_tax|currency }}</td>
            <td>{{ form.instance.line_price_incl_tax|currency }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</form>

<div id="basket_totals">
	<table>
		{% for discount in basket.discounts %}
		<tr>
			<td colspan="7">{{ discount.name }}</td>
			<td colspan="3">-{{ discount.discount|currency }}</td>
		</tr>
		{% endfor %}
		<tr>
			<th colspan="5">Basket total</th>
			<td>{{ basket.total_incl_tax|currency }}</td>
			<td></td>
		</tr>
		<tr>
			<th colspan="5">Shipping ({{ shipping_method.name }})</th>
			<td>{{ shipping_charge_incl_tax|currency }}</td>
			<td></td>
		</tr>
		<tr>
			<th colspan="5">Order total</th>
			<td>{{ order_total_incl_tax|currency }}</td>
			<td></td>
		</tr>
	</table>
</div>
	
<div class="form-actions">
	<a href="{% url checkout:index %}" class="pull-right btn btn-large btn-primary">Proceed to checkout</a>
</div>

{% if request.basket.pk %}

<h4>Basket vouchers</h4>
<ul>
    {% for voucher in basket.vouchers.all %}
    <li>
        <form action="{% url basket:vouchers-remove voucher.id %}" method="POST">
            {% csrf_token %}
            {{ voucher.name }} ({{ voucher.code }})
            <input type="submit" value="Remove" class="btn"/>
        </form>
    </li>
    {% endfor %}
</ul>
{% endif %}

<form action="{% url basket:vouchers-add %}" method="post" class="form-horizontal">
    {% csrf_token %}
    {% include "partials/form_fields.html" with form=voucher_form %}
    <div class="form-actions">
        <input type="submit" value="Add voucher" class="btn"/>
    </div>
</form>

{% else %}

<p>Your basket is empty, you should probably add some items to buy.</p>

{% endif %}


<div class="page-header">
    <h2>To buy later</h2>
</div>

{% if not saved_formset %}
<p>Your saved basket is empty.</p>

{% else %}
<form action="{% url basket:saved %}" method="post" class="form-stacked later_summary" id="saved_basket_formset">
    {% csrf_token %}

    {{ saved_formset.management_form }}

    <table class="bordered-table zebra-striped">
        <tbody>
        {% for form in saved_formset %}
        <tr>
			<td>
				{{ form.id }}
				{% product_image form.instance.product as product_image %}
				<div style="width:100px">
					<a href="{{ product.get_absolute_url }}"><img class="thumbnail" src="{{ product_image.thumbnail_url }}" alt="{{ product.get_title }}"></a>
				</div>
				<a href="{{ form.instance.product.get_absolute_url }}">{{ form.instance.description }}</a><br/>
				{{ form.instance.product.stockrecord.availability }}
			</td>
			<td>
				<a href="#" data-id="{{ forloop.counter0 }}" class="remove">Remove</a>
				| <a href="#" data-id="{{ forloop.counter0 }}" class="move">Move to basket</a>
				<div style="display:none">
					{{ form.move_to_basket }}
					{{ form.DELETE }}
				</div>
			</td>
            <td>{{ form.instance.unit_price_incl_tax|currency }}</td>
            <td>{{ form.instance.line_price_incl_tax|currency }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class="form-actions">
		<a href="{% url checkout:index %}" class="pull-right btn btn-primary btn-large">Proceed to Checkout</a>
    </div>

</form>
{% endif %}

{% endblock content %}

{% block onbodyload %}
oscar.basket.init();
{% endblock %}

