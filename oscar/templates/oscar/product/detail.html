{% extends "layout.html" %}

{% load currency_filters %}
{% load history_tags %}
{% load thumbnail %}

{% block header %}
<h2>{{ item.get_title }}</h2>
{% endblock header %}


{% block content %}
<div class="images">
    {% for image in item.images.all %}
    {% thumbnail image.original "200" crop="center" as im %}
        <img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
    {% endthumbnail %}
    {% if image.caption %}
        <div class="caption">{{ image.caption }}</div>
    {% endif %}
    {% endfor %}
</div>

<table>
    <caption>Product details</caption>
    <tr>
        <th>UPC</th><td>{{item.upc}}</td>
    </tr>
    <tr>
        <th>Product class</th><td><a href="{{ item.item_class.get_absolute_url }}">{{item.item_class.name}}</a></td>
    </tr>
    {% if item.stockrecord %}
    <tr>
        <th>Price (excl. tax)</th><td>{{item.stockrecord.price_incl_tax|currency}}</td>
    </tr>
    <tr>
        <th>Price (incl. tax)</th><td>{{item.stockrecord.price_excl_tax|currency}}</td>
    </tr>
    <tr>
        <th>Availability</th>
        <td>{{ item.stockrecord.availability }}</td>
    </tr>
    {% endif %}
    <tr>
        <th>Product type</th>
        <td>
        {% if item.is_group %}Product group{% else %}{% if item.is_variant %}Variant{% else %}Stand-alone{% endif %}{% endif %}
        </td>
    </tr>
    {% for attribute in item.attributes.all %}
    <tr>
        <th>{{ attribute.type.name }}</th>
        <th>{{ attribute.value }}</th>
    </tr>
    {% endfor %}
    <tr>
        <td><a href="{% url oscar-product-review-add item.item_class.slug item.slug item.id %}">Add a review</a></td>
        <td><a href="{% url oscar-product-reviews item.item_class.slug item.slug item.id %}">See all reviews</a></td>
    </tr>
    
</table>

{% if item.stockrecord %}
<form action="{% url oscar-basket %}" method="post">
    {% csrf_token %}
    {{ basket_form.as_p }}
    <input type="submit" value="Add to basket" />
</form>
{% endif %}

{% if item.related_items.count %}
<div class="products">
    <h4>Related items</h4>
    <ul>
    {% for product in item.related_items.all %}
        <li><a href="{{ product.get_absolute_url }}">{{ product.get_title }}</a>
    {% endfor %}
    </ul>
</div>
{% endif %}

{% if item.recommended_items.count %}
<div class="products">
    <h4>Recommended items</h4>
    <ul>
    {% for product in item.recommended_items.all %}
        <li><a href="{{ product.get_absolute_url }}">{{ product.get_title }}</a>
    {% endfor %}
    </ul>
</div>
{% endif %}

{% block product_review %}

    {% if reviews %}
    	<h3> Product Reviews </h3>
    	<h4> Average score: {{ avg_score|floatformat:1  }} / 5.0 </h4>
    	{% for review in reviews|slice:":5" %}		
    		<h4> {{ forloop.counter}}. {{ review.title }} by {{ review.user.username }} </h4>
    		<p> Score: {{ review.score|floatformat:1 }} / 5.0</p>
    		<p> Comments: {{ review.body|truncatewords:50 }}</p>		
    		<p> Date created: {{ review.date_created }}</p>
    		<a href="{{ review.get_absolute_url }}">View full review</a>			
            {% if review.has_votes %}
            	<h5> {{ review.num_up_votes }} out of {{ review.total_votes }} customers found this review useful.</h5>
            {% endif %}
            {% if user.is_authenticated %}
        		<h4>Was this review helpful to you?</h4>
        		<form action="{{ review.get_absolute_url }}" method="post">
        			{% csrf_token %}               
                    <input type="hidden" name="action" value="vote_up"/>
                    <input type="submit" value="Yes" /> 
                </form>
        		<form  action="{{ review.get_absolute_url }}" method="post">
        			{% csrf_token %}                
                    <input type="hidden" name="action" value="vote_down"/>
                    <input type="submit" value="No" /> 
                </form>
    	    {% endif %}			
    	{% endfor %}
    {% endif %}

{% endblock product_review %}

{% recently_viewed_products %}

{% endblock content %}

